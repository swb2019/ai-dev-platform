name: Terraform

on:
  workflow_dispatch:
  pull_request:
    paths:
      - 'infra/terraform/**'
      - 'scripts/bootstrap-infra.sh'
      - '.github/workflows/terraform.yml'
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'

permissions:
  contents: read
  id-token: write
  pull-requests: write

env:
  TF_IN_AUTOMATION: 'true'
  TF_CLI_ARGS_init: '-input=false'
  TF_CLI_ARGS_plan: '-input=false'
  TF_CLI_ARGS_apply: '-input=false'
  TERRAFORM_VERSION: '1.8.5'

jobs:
  context:
    name: Context
    runs-on: ubuntu-latest
    steps:
      - run: echo "::notice::Terraform workflow triggered on $GITHUB_REF via $GITHUB_EVENT_NAME"

  skip:
    if: github.event_name == 'push' && github.ref != 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - run: echo "Terraform applies run only on main; current ref ${{ github.ref }}."

  plan:
    name: Plan (staging)
    if: ${{ github.event_name == 'pull_request' && secrets.TERRAFORM_SERVICE_ACCOUNT != '' }}
    runs-on: ubuntu-latest
    environment: staging
    concurrency:
      group: terraform-plan-${{ github.run_id }}
      cancel-in-progress: false
    defaults:
      run:
        shell: bash
        working-directory: infra/terraform/envs/staging
    env:
      TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
      TF_VAR_region: ${{ secrets.GCP_REGION }}
      TF_VAR_github_repository: ${{ github.repository }}
      TF_VAR_runtime_service_account_namespace: ${{ secrets.RUNTIME_KSA_NAMESPACE }}
      TF_VAR_runtime_service_account_name: ${{ secrets.RUNTIME_KSA_NAME }}
      TF_VAR_binary_authorization_attestors: ${{ secrets.BA_ATTESTORS }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.TERRAFORM_SERVICE_ACCOUNT }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          create_credentials_file: true

      - name: Terraform Fmt
        run: terraform fmt -check -recursive ../../..

      - name: Terraform Init
        run: terraform init -upgrade

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        id: plan
        continue-on-error: true
        run: |
          terraform plan -out=tfplan
          terraform show -no-color tfplan > plan.txt

      - name: Upload Plan Artifact
        if: steps.plan.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-staging
          path: infra/terraform/envs/staging/plan.txt

      - name: Comment Plan on PR
        if: steps.plan.outcome == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'infra/terraform/envs/staging/plan.txt';
            let plan = fs.readFileSync(path, 'utf8');
            const maxLength = 60000;
            const truncated = plan.length > maxLength;
            if (truncated) {
              plan = `${plan.slice(0, maxLength)}\n\n... plan output truncated; see artifact terraform-plan-staging for full details.`;
            }
            const safePlan = plan.replace(/```/g, '\\`\\`\\`');
            const body = [
              '## Terraform Plan (staging)',
              truncated ? '> Plan output truncated for comment length limits.' : '',
              '<details><summary>Show plan</summary>',
              '',
              '```',
              safePlan,
              '```',
              '</details>',
              '',
              '_Artifact_: terraform-plan-staging'
            ].filter(Boolean).join('\n');
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

      - name: Fail if Plan Failed
        if: steps.plan.outcome != 'success'
        run: |
          echo "Terraform plan failed"
          exit 1

  explain-apply-skip:
    name: Terraform Apply (skipped)
    if: ${{ github.event_name == 'push' && !(((github.ref == 'refs/heads/main' && vars.STAGING_INFRA_ENABLED == 'true') || (startsWith(github.ref, 'refs/tags/v') && vars.PRODUCTION_INFRA_ENABLED == 'true')) && secrets.TERRAFORM_SERVICE_ACCOUNT != '' && secrets.WORKLOAD_IDENTITY_PROVIDER != '' && secrets.GCP_PROJECT_ID != '' && secrets.GCP_REGION != '' && secrets.RUNTIME_KSA_NAMESPACE != '' && secrets.RUNTIME_KSA_NAME != '' && secrets.BA_ATTESTORS != '') }}
    runs-on: ubuntu-latest
    steps:
      - name: Summarize missing prerequisites
        run: |
          missing=()
          add_missing() { missing+=("$1"); }
          [ -n "${{ secrets.TERRAFORM_SERVICE_ACCOUNT }}" ] || add_missing "TERRAFORM_SERVICE_ACCOUNT"
          [ -n "${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}" ] || add_missing "WORKLOAD_IDENTITY_PROVIDER"
          [ -n "${{ secrets.GCP_PROJECT_ID }}" ] || add_missing "GCP_PROJECT_ID"
          [ -n "${{ secrets.GCP_REGION }}" ] || add_missing "GCP_REGION"
          [ -n "${{ secrets.RUNTIME_KSA_NAMESPACE }}" ] || add_missing "RUNTIME_KSA_NAMESPACE"
          [ -n "${{ secrets.RUNTIME_KSA_NAME }}" ] || add_missing "RUNTIME_KSA_NAME"
          [ -n "${{ secrets.BA_ATTESTORS }}" ] || add_missing "BA_ATTESTORS"
          toggles=()
          if [ "${GITHUB_REF}" = "refs/heads/main" ]; then
            [ "${{ vars.STAGING_INFRA_ENABLED }}" = "true" ] || toggles+=("vars.STAGING_INFRA_ENABLED")
          elif [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            [ "${{ vars.PRODUCTION_INFRA_ENABLED }}" = "true" ] || toggles+=("vars.PRODUCTION_INFRA_ENABLED")
          fi
          message="Terraform apply skipped."
          if [ "${#missing[@]}" -gt 0 ]; then
            message+=" Missing secrets: ${missing[*]}."
          fi
          if [ "${#toggles[@]}" -gt 0 ]; then
            message+=" Enable toggles: ${toggles[*]}."
          fi
          echo "::notice::${message}"

  apply:
    name: Apply
    if: ${{ github.event_name == 'push' && ((github.ref == 'refs/heads/main' && vars.STAGING_INFRA_ENABLED == 'true') || (startsWith(github.ref, 'refs/tags/v') && vars.PRODUCTION_INFRA_ENABLED == 'true')) && secrets.TERRAFORM_SERVICE_ACCOUNT != '' && secrets.WORKLOAD_IDENTITY_PROVIDER != '' && secrets.GCP_PROJECT_ID != '' && secrets.GCP_REGION != '' && secrets.RUNTIME_KSA_NAMESPACE != '' && secrets.RUNTIME_KSA_NAME != '' && secrets.BA_ATTESTORS != '' }}
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'staging' || 'production' }}
    concurrency:
      group: terraform-apply-${{ github.ref == 'refs/heads/main' && 'staging' || 'production' }}
      cancel-in-progress: false
    defaults:
      run:
        shell: bash
    env:
      TARGET_ENVIRONMENT: ${{ github.ref == 'refs/heads/main' && 'staging' || 'production' }}
      TERRAFORM_CONFIG_DIR: ${{ github.ref == 'refs/heads/main' && 'infra/terraform/envs/staging' || 'infra/terraform/envs/prod' }}
      TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
      TF_VAR_region: ${{ secrets.GCP_REGION }}
      TF_VAR_github_repository: ${{ github.repository }}
      TF_VAR_runtime_service_account_namespace: ${{ secrets.RUNTIME_KSA_NAMESPACE }}
      TF_VAR_runtime_service_account_name: ${{ secrets.RUNTIME_KSA_NAME }}
      TF_VAR_binary_authorization_attestors: ${{ secrets.BA_ATTESTORS }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.TERRAFORM_SERVICE_ACCOUNT }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          create_credentials_file: true

      - name: Show Target Environment
        run: |
          echo "Deploying infrastructure to ${TARGET_ENVIRONMENT}"

      - name: Terraform Init
        run: terraform init -upgrade
        working-directory: ${{ env.TERRAFORM_CONFIG_DIR }}

      - name: Terraform Validate
        run: terraform validate
        working-directory: ${{ env.TERRAFORM_CONFIG_DIR }}

      - name: Terraform Apply
        run: terraform apply -auto-approve
        working-directory: ${{ env.TERRAFORM_CONFIG_DIR }}
